extends layout

block content
  h1 国別情報
  - const country_data = []//{ country, dhl: {total, max, min, count}, ems: {...}, other: {...} }
  - const shipping_times = []
  each row in rows
    - const sdate = new Date(row.shippeddate)
    - const edate = new Date(row.delivereddate)
    - const timediff = Math.round((row.delivereddate - row.shippeddate) / 86400000)
    - shipping_times.push(timediff)
    - let added = false
    each c in country_data
      if c.country == row.country
        if row.carrier == 'DHL'
          if c.dhl.min > timediff
            - c.dhl.min = timediff
          if c.dhl.max < timediff
            - c.dhl.max = timediff
          - c.dhl.total += timediff
          - c.dhl.count++
        else if row.tracking.indexOf('EM') == 0
          if c.ems.min > timediff
            - c.ems.min = timediff
          if c.ems.max < timediff
            - c.ems.max = timediff
          - c.ems.total += timediff
          - c.ems.count++
        else
          if c.other.min > timediff
            - c.other.min = timediff
          if c.other.max < timediff
            - c.other.max = timediff
          - c.other.total += timediff
          - c.other.count++
        - added = true
    if added == false
      - country_data.push({ country: row.country, dhl: { total: 0, max: 0, min: 1000, count: 0 }, ems: { total: 0, max: 0, min: 1000, count: 0 }, other: { total: 0, max: 0, min: 1000, count: 0 }})
      - const index = country_data.length - 1
      if row.carrier == 'DHL'
        - country_data[index].dhl.total = timediff
        - country_data[index].dhl.max = timediff
        - country_data[index].dhl.min = timediff
        - country_data[index].dhl.count = 1
      else if row.tracking.indexOf('EM') == 0
        - country_data[index].ems.total = timediff
        - country_data[index].ems.max = timediff
        - country_data[index].ems.min = timediff
        - country_data[index].ems.count = 1
      else
        - country_data[index].other.total = timediff
        - country_data[index].other.max = timediff
        - country_data[index].other.min = timediff
        - country_data[index].other.count = 1
  table.table.table-dark.table-striped
    thead
      tr
        th(scope="col") Country
        th(scope="col") DHL shipping time
        th(scope="col") EMS shipping time
        th(scope="col") Other shipping time
    tbody
      each country in country_data
        tr
          td= country.country
          if country.dhl.count > 0
            td
              b= `${Math.round(100 * country.dhl.total / country.dhl.count) / 100} days `
              i= `(${country.dhl.min}-${country.dhl.max} days)`
          else
            td
          if country.ems.count > 0
            td
              b= `${Math.round(100 * country.ems.total / country.ems.count) / 100} days `
              i= `(${country.ems.min}-${country.ems.max} days)`
          else
            td
          if country.other.count > 0
            td
              b= `${Math.round(100 * country.other.total / country.other.count) / 100} days `
              i= `(${country.other.min}-${country.other.max} days)`
          else
            td
  i *Unchecked packages are not included (DHL: within 3 days from shipment, EMS: within 5 days from shipment, Other: within 21 days from shipment)
  table.table.table-dark.table-striped
    thead
      tr
        th(scope="col") Attribute
        th(scope="col") Value
    tbody
      tr
        td Total packages
        td= rows.length + undelivered.length
      tr
        td Delivered packages
        td= `${rows.length} (${Math.round(10000*rows.length/(rows.length + undelivered.length))/100}%)`
  svg#chart
  #chart_data= JSON.stringify(shipping_times)
  script(src="https://d3js.org/d3.v5.min.js")
  script(src="/javascripts/d3_controller.js")

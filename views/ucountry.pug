extends layout

block content
  h1 国別情報（
    a(href="/mypage/undelivered_country") 全国
    | ）
  i ※対象外：DHL発送から3日以内、EMS発送から5日以内、Air/SAL発送から21日以内
  - const country_data = []//{ country, dhl: {total, max, min, count}, ems: {...}, other: {...} }
  - const shipping_times = []
  each row in undelivered
    - const timediff = Math.round((Date.now() - row.shippeddate) / 86400000)
    - shipping_times.push(timediff)
    - let added = false
    each c in country_data
      if c.country == row.country
        if row.carrier == 'DHL'
          if c.dhl.min > timediff
            - c.dhl.min = timediff
          if c.dhl.max < timediff
            - c.dhl.max = timediff
          - c.dhl.total += timediff
          - c.dhl.count++
        else if row.tracking.indexOf('EM') == 0
          if c.ems.min > timediff
            - c.ems.min = timediff
          if c.ems.max < timediff
            - c.ems.max = timediff
          - c.ems.total += timediff
          - c.ems.count++
        else
          if c.other.min > timediff
            - c.other.min = timediff
          if c.other.max < timediff
            - c.other.max = timediff
          - c.other.total += timediff
          - c.other.count++
        - added = true
    if added == false
      - country_data.push({ country: row.country, dhl: { total: 0, max: 0, min: 1000, count: 0 }, ems: { total: 0, max: 0, min: 1000, count: 0 }, other: { total: 0, max: 0, min: 1000, count: 0 }})
      - const index = country_data.length - 1
      if row.carrier == 'DHL'
        - country_data[index].dhl.total = timediff
        - country_data[index].dhl.max = timediff
        - country_data[index].dhl.min = timediff
        - country_data[index].dhl.count = 1
      else if row.tracking.indexOf('EM') == 0
        - country_data[index].ems.total = timediff
        - country_data[index].ems.max = timediff
        - country_data[index].ems.min = timediff
        - country_data[index].ems.count = 1
      else
        - country_data[index].other.total = timediff
        - country_data[index].other.max = timediff
        - country_data[index].other.min = timediff
        - country_data[index].other.count = 1
  table.table.table-dark.table-striped
    thead
      tr
        th(scope="col") 国名
        th(scope="col") DHL配送時間
        th(scope="col") EMS配送時間
        th(scope="col") Air/SAL配送時間
    tbody
      each country in country_data
        tr
          td= country.country
          if country.dhl.count > 0
            td
              b= `${Math.round(100 * country.dhl.total / country.dhl.count) / 100}日 `
              i= `(${country.dhl.count}件、${country.dhl.min}-${country.dhl.max}日)`
          else
            td
          if country.ems.count > 0
            td
              b= `${Math.round(100 * country.ems.total / country.ems.count) / 100}日 `
              i= `(${country.ems.count}件、${country.ems.min}-${country.ems.max}日)`
          else
            td
          if country.other.count > 0
            td
              b= `${Math.round(100 * country.other.total / country.other.count) / 100}日 `
              i= `(${country.other.count}件、${country.other.min}-${country.other.max}日)`
          else
            td
  table.table.table-dark.table-striped
    thead
      tr
        th(scope="col") 情報
        th(scope="col") 値
    tbody
      tr
        td 全荷物
        td= rows.length + undelivered.length
      tr
        td 未着
        td= `${undelivered.length} (${Math.round(10000*undelivered.length/(rows.length + undelivered.length))/100}%)`
  svg#chart
  #chart_data.hidden= JSON.stringify(shipping_times)
  script(src="https://d3js.org/d3.v5.min.js")
  script(src="/javascripts/d3_controller.js")
